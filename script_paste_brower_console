(async function () {
    // X√≥a th∆∞ vi·ªán c≈© n·∫øu c√≥ ƒë·ªÉ tr√°nh xung ƒë·ªôt
    if (window.jspdf) delete window.jspdf;
    const oldScript = document.getElementById('pdf-script');
    if (oldScript) oldScript.remove();

    console.log("%cüöÄ ƒêang qu√©t file m·ªõi...", "color: #ffaa00; font-weight: bold;");

    const loadJsPDF = () => {
        return new Promise((resolve, reject) => {
            const script = document.createElement("script");
            script.id = 'pdf-script';
            script.src = "https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js";
            script.onload = resolve;
            script.onerror = reject;
            document.body.appendChild(script);
        });
    };

    try {
        await loadJsPDF();
        // ƒê·ª£i m·ªôt ch√∫t ƒë·ªÉ th∆∞ vi·ªán s·∫µn s√†ng ho√†n to√†n
        await new Promise(r => setTimeout(r, 500));
        
        const { jsPDF } = window.jspdf;
        // Ch·ªâ l·∫•y c√°c ·∫£nh ƒëang th·ª±c s·ª± HI·ªÇN TH·ªä (visibility)
        const validImgs = Array.from(document.querySelectorAll("img")).filter(img => {
            return img.src.startsWith("blob:") && 
                   img.naturalWidth > 200 && 
                   img.offsetParent !== null; // Ki·ªÉm tra ·∫£nh kh√¥ng b·ªã ·∫©n
        });

        if (validImgs.length === 0) {
            alert("Kh√¥ng t√¨m th·∫•y trang n√†o. H√£y cu·ªôn chu·ªôt xu·ªëng ƒë·ªÉ load ·∫£nh!");
            return;
        }

        const pdf = new jsPDF({
            orientation: validImgs[0].naturalWidth > validImgs[0].naturalHeight ? "l" : "p",
            unit: "px",
            format: [validImgs[0].naturalWidth, validImgs[0].naturalHeight],
        });

        for (let i = 0; i < validImgs.length; i++) {
            const img = validImgs[i];
            const canvas = document.createElement("canvas");
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            canvas.getContext("2d").drawImage(img, 0, 0);
            if (i > 0) pdf.addPage([img.naturalWidth, img.naturalHeight]);
            pdf.addImage(canvas.toDataURL("image/jpeg", 0.9), "JPEG", 0, 0, img.naturalWidth, img.naturalHeight);
        }

        let name = (document.title.split(" - Google Drive")[0] || "File_moi") + ".pdf";
        pdf.save(name);
        console.log("‚úÖ ƒê√£ xong file: " + name);
    } catch (e) {
        console.error("L·ªói:", e);
    }
})();
